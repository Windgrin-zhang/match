# 乳腺图像分类与特征检测系统运行流程

## 项目概述

本项目是一个基于YOLOv8的乳腺图像分类与特征检测系统，包含两个主要任务：
1. **分类任务（Classification）**：对乳腺图像进行6类分类（2，3，4A, 4B, 4C, 5）
2. **特征检测任务（Feature Detection）**：检测乳腺图像的4个特征（边界、钙化、方向、形状）

## 环境要求

### 系统要求
- Python 3.12.7
- Windows 10/11
- CUDA 11.8（GPU加速，可选）

### 核心依赖包
```bash
ultralytics==8.3.7          # YOLOv8框架
torch==2.4.1               # PyTorch深度学习框架
opencv-python==4.10.0.84   # 图像处理
pandas==2.2.3              # 数据处理
scikit-learn               # 机器学习评估
optuna                     # 超参数优化（可选）
```

## 文件结构说明

```
demo/
├── 数据预处理/
│   ├── huizong.py              # 训练数据汇总
│   ├── huizongA.py             # 测试数据汇总
│   ├── huizong_cla__gt.py      # 生成分类真实标签
│   ├── change_labels.py        # 标签数值调整
│   ├── create_fea_val.py       # 创建特征验证集
│   └── k-fold-train.py         # K折交叉验证数据分割
├── 模型训练/
│   ├── train_cla.py            # 分类模型训练
│   └── train_fea.py            # 特征检测模型训练
├── 模型测试/
│   ├── test_cla.py             # 分类模型测试
│   ├── test.py                 # 特征检测模型测试
│   ├── run_cla.py              # 分类模型运行
│   └── run_B_cla.py            # B数据集分类测试
├── 结果评估/
│   ├── score.py                # 模型性能评估
│   └── score (2).py            # 备用评估脚本
├── 数据转换/
│   └── transform_images.py     # 图像格式转换
└── 测试数据/
    └── test_A/
        └── create_csv.py       # 生成特征真实标签
```

## 运行流程

### 第一阶段：数据预处理

#### 1. 训练数据汇总 (`huizong.py`)
**功能**：将分散的训练数据汇总到统一目录
```python
# 执行命令
python demo/huizong.py

# 主要功能：
# - 将train_cla/train中的所有图片和标签汇总到Real_train
# - 随机选择1/10数据作为验证集
# - 标签数值减1（从1-6调整为0-5）
```

#### 2. 测试数据汇总 (`huizongA.py`)
**功能**：汇总测试数据
```python
# 执行命令
python demo/huizongA.py

# 主要功能：
# - 将test_A/A_test_cla/A中的图片和标签汇总到Real_A
```

#### 3. 生成真实标签 (`huizong_cla__gt.py`)
**功能**：生成分类任务的真实标签CSV文件
```python
# 执行命令
python demo/huizong_cla__gt.py

# 输出文件：
# - runs/csv/cla_gt.csv：分类真实标签
```

#### 4. 创建特征验证集 (`create_fea_val.py`)
**功能**：为特征检测任务创建验证集
```python
# 执行命令
python demo/create_fea_val.py

# 主要功能：
# - 从训练集中随机选择1/10数据作为验证集
# - 合并4个特征的标签文件
# - 标签值转换：boundary(0-1), calcification(2-3), direction(4-5), shape(6-7)
```

#### 5. K折交叉验证（可选）(`k-fold-train.py`)
**功能**：创建K折交叉验证数据集
```bash
# 执行命令
python demo/k-fold-train.py --data ./data --ksplit 10

# 参数说明：
# --data：数据集路径
# --ksplit：K折数量（默认10）
```

### 第二阶段：模型训练

#### 6. 分类模型训练 (`train_cla.py`)
**功能**：训练乳腺图像分类模型
```python
# 执行命令
python demo/train_cla.py

# 训练配置：
# - 模型：YOLOv8n
# - 数据：A_cla.yaml
# - 类别：6类（0-5对应2-4A, 4B, 4C, 5）
# - 优化：贝叶斯优化（Optuna）
# - 参数：学习率、HSV饱和度、对比度
```

#### 7. 特征检测模型训练 (`train_fea.py`)
**功能**：训练乳腺图像特征检测模型
```python
# 执行命令
python demo/train_fea.py

# 训练配置：
# - 模型：YOLOv8n
# - 数据：A_fea.yaml
# - 类别：8类（4个特征×2个值）
# - 优化：贝叶斯优化（Optuna）
# - 参数：学习率、HSV饱和度、对比度
```

### 第三阶段：模型测试

#### 8. 分类模型测试 (`test_cla.py`)
**功能**：使用训练好的分类模型进行预测
```python
# 执行命令
python demo/test_cla.py

# 主要功能：
# - 加载训练好的分类模型
# - 对测试图像进行预测
# - 输出预测结果到CSV文件
# - 输出文件：runs/csv/cla_pre.csv
```

#### 9. 特征检测模型测试 (`test.py`)
**功能**：使用训练好的特征检测模型进行预测
```python
# 执行命令
python demo/test.py

# 主要功能：
# - 加载训练好的特征检测模型
# - 对测试图像进行预测
# - 输出4个特征的预测结果
# - 输出文件：runs/csv/fea_pre.csv
```

#### 10. 生成特征真实标签 (`test_A/create_csv.py`)
**功能**：生成特征检测任务的真实标签
```python
# 执行命令
python demo/test_A/create_csv.py

# 输出文件：
# - runs/csv/fea_gt.csv：特征真实标签
```

### 第四阶段：结果评估

#### 11. 模型性能评估 (`score.py`)
**功能**：计算模型性能指标
```python
# 执行命令
python demo/score.py

# 评估指标：
# - 分类任务：准确率、F1分数
# - 特征检测：各特征准确率、F1分数
# - 最终得分：0.3×(分类准确率+特征平均准确率) + 0.2×(分类F1+特征平均F1)
```

## 配置文件说明

### YAML配置文件
- `A_cla.yaml`：分类任务数据配置
- `A_fea.yaml`：特征检测任务数据配置

### 数据目录结构
```
data/
├── images/                 # 训练图像
├── labels/                 # 训练标签
├── classes.yaml           # 类别定义
└── val/                   # 验证集
    ├── images/
    └── labels/
```

## 注意事项

### 1. 数据准备
- 确保图像和标签文件一一对应
- 图像格式支持：jpg, jpeg, png, bmp
- 标签格式：YOLO格式（类别 x_center y_center width height）

### 2. 模型训练
- 建议使用GPU加速训练
- 根据数据量调整batch_size
- 监控训练过程中的loss变化

### 3. 文件路径
- 所有路径使用相对路径
- 确保runs/csv/目录存在
- 检查模型权重文件路径正确性

### 4. 性能优化
- 使用Optuna进行超参数优化
- 根据验证集性能选择最佳模型
- 考虑使用数据增强提高泛化能力

## 常见问题解决

### 1. 内存不足
- 减小batch_size
- 使用更小的模型（如YOLOv8n）
- 减少图像尺寸

### 2. 训练不收敛
- 检查学习率设置
- 验证数据标签正确性
- 调整数据增强参数

### 3. 预测结果异常
- 确认模型权重文件路径
- 检查输入图像格式
- 验证类别映射关系

## 扩展功能

### 1. 模型导出
```python
# 导出ONNX格式
model.export(format="onnx")

# 导出TensorRT格式
model.export(format="engine")
```

### 2. 批量预测
- 支持批量图像处理
- 可配置预测阈值
- 支持结果可视化

### 3. 模型集成
- 多模型投票
- 集成学习
- 模型融合

## 版本信息

- **Ultralytics版本**：8.3.7
- **PyTorch版本**：2.4.1
- **CUDA版本**：11.8
- **Python版本**：3.12.7

---

**注意**：本系统专为乳腺图像分析设计，请确保数据隐私和医疗合规性。
